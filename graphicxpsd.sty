\ProvidesPackage{graphicxpsd}
  [2017/10/15 v0.2  Supporting Adobe Photoshop format (PSD) for graphicx via sips command]

%% support the extension .psd
\@namedef{Gin@rule@.PSD}#1{{psd}{.xbb}{#1}}
\@namedef{Gin@rule@.psd}#1{{psd}{.xbb}{#1}}

%% include .psd file
\let\Ginclude@psd\Ginclude@bmp

\@ifundefined{GPT@space}{%%TL2016 or lower version
  \def\GPT@space{ }%
%% read .psd file
\def\Gread@psd#1{%
  \typeout{converting: \Gin@base\Gin@ext\space -> \Gin@base.png}%
  \immediate\write18{sips -s format png \Gin@base\Gin@ext\GPT@space --out \Gin@base4dpx.png}%
  %% renamed inside: foo.psd -> foo4dpx.png
  \let\clone@Gin@base\Gin@base
  \def\Gin@base{\clone@Gin@base4dpx}%
  \def\Gin@ext{.png}%
% \typeout{!!! #1}%%=> tigerpsdfmt4dpx.xbb
% \typeout{!!! \Gin@base\Gin@ext}%%=> tigerpsdfmt4dpx.png
  \edef\@tempa{pdf@bbox@cache@\Gin@page @\GPT@pagebox @#1}%
  \expandafter\expandafter\expandafter\@ifundefined
    \expandafter{\@tempa}{\Gread@@pdf{#1}}{%
      \edef\@gtempa{\csname\@tempa\endcsname}%
      \expandafter\Gread@parse@bb\@gtempa\\}}%
}{%%TL2017 or higher version
%% read .psd file
\def\Gread@psd#1{%
  \typeout{converting: \Gin@base\Gin@ext\space -> \Gin@base.png}%
  \immediate\write18{sips -s format png \Gin@base\Gin@ext\GPT@space --out \Gin@base4dpx.png}%
  %% renamed inside: foo.psd -> foo4dpx.png
  \let\clone@Gin@base\Gin@base
  \def\Gin@base{\clone@Gin@base4dpx}%
  \def\Gin@ext{.png}%
% \typeout{!!! #1}%%=> tigerpsdfmt4dpx.xbb
% \typeout{!!! \Gin@base\Gin@ext}%%=> tigerpsdfmt4dpx.png
  \Gread@generic{#1}%
  \Gread@extractbb@aux}%\Gread@psd@aux
}

\endinput
